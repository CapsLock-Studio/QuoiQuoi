<%= render 'layouts/breadcrumbs' %>
<div class="container main-container">
  <div class="row row-offcanvas row-offcanvas-left">
    <%= render 'side_navigation' %>
    <div class="col-sm-9 col-xs-12">
      <%= render 'layouts/flash_message' %>
      <div class="row margin-bottom-60">
        <%= render 'layouts/nav_item' %>
        <% translate = @course.course_translates.where(locale_id: session[:locale_id]).first %>
        <div class="col-sm-6 col-xs-12">
          <div class="row">
            <div class="col-xs-12 nopadding">
              <div class="well-sm" style="margin-top:0;padding-top:0;">
                <a class="mediumnail fancybox-button zoomer" data-rel="fancybox-button" title="<%= translate.name %>" href="<%= asset_path @course.image.url(:large) %>">
                  <span class="overlay-zoom">
                    <%= image_tag @course.image.url(:medium), class: 'img-responsive' %>
                    <div class="zoom-icon"></div>
                  </span>
                </a>
              </div>
            </div>

            <a href="#" class="col-xs-4 nopadding"
               data-toggle="preview-change"
               data-large="<%= asset_path @course.image.url(:large) %>"
               data-medium="<%= asset_path @course.image.url(:medium) %>">
              <div class="well-sm">
                <%= image_tag @course.image.url(:thumb), class: 'img-responsive' %>
              </div>
            </a>
            <% @course.course_images.each do |course_image| %>
              <a href="#" class="col-xs-4 nopadding"
                 data-toggle="preview-change"
                 data-large="<%= asset_path course_image.image.url(:large) %>"
                 data-medium="<%= asset_path course_image.image.url(:medium) %>">
                <div class="well-sm">
                  <%= image_tag course_image.image.url(:thumb), class: 'img-responsive' %>
                </div>
              </a>
            <% end %>
          </div>
        </div>
        <div class="col-sm-6 col-xs-12">
          <div class="row">
            <div class="col-md-12 margin-bottom-50">
              <h3 style="color:#666;">
                <strong>
                  <%= translate.name %>
                </strong>
              </h3>
              <ul class="list-unstyled">
                <li>
                  <span><%= t('course_time') %></span>:&nbsp;<strong><%= "#{@course.time.strftime('%Y/%m/%d %H:%M')} - #{(@course.time + @course.length.hours).strftime('%H:%M')}" %></strong>
                </li>
                <li>
                  <span><%= t('teacher') %></span>:&nbsp;<strong><%= translate.teacher %></strong>
                </li>
              </ul>
              <%= simple_format(translate.description) %>
            </div>
            <% if @course.visible? %>
              <div class="col-md-12 margin-bottom-10">
                <h4 class="margin-bottom-20">
                  <strong style="color:#666;"><%= number_to_currency(translate.price) %></strong>
                  <small><%= translate.note %></small>
                </h4>

                <%= form_for @registration, url: new_registration_path, method: :get do |f| %>
                  <%= f.hidden_field :course_id %>
                  <% options = CourseOption.where(course_id: @course.id, locale_id: session[:locale_id]).order(:id).collect{|option| [option.content, option.id]} %>
                  <% if options.length > 0 %>
                    <label><%= t('option') %></label>
                    <%= f.select :course_option_id, options, {}, class: 'selectpicker form-control', data: {width: '100%'} %>
                  <% end %>

                  <% if @course.canceled? %>
                    <a href="#" class="btn btn-orange btn-lg btn-block hover-effect" disabled="disabled">
                      <span><%= t('course.canceled') %></span>
                    </a>
                  <% elsif @course.time > Time.now + 5.hours %>
                    <% if @course.popular <= @course.registrations.collect{|registration| (!registration.canceled? && registration.payment && registration.payment.completed?)? registration.attendance : 0}.inject{|sum, attendance| sum + attendance} %>
                      <a href="#" class="btn btn-orange btn-lg btn-block hover-effect" disabled="disabled">
                        <span><%= t('registration.full') %></span>
                      </a>
                    <% elsif current_user && @registration.id && @registration.payment %>
                      <button type="submit" class="btn btn-orange btn-lg btn-block hover-effect">
                        <span><%= t('had_registered') %></span>
                      </button>
                    <% else %>
                      <button type="submit" class="btn btn-orange btn-lg btn-block hover-effect">
                        <i class="fa fa-edit"></i>
                        <span><%= t('register') %></span>
                      </button>
                    <% end %>
                  <% else %>
                    <a href="#" class="btn btn-orange btn-lg btn-block hover-effect" disabled="disabled">
                      <span><%= t('course.past') %></span>
                    </a>
                  <% end %>
                <% end %>
              </div>
            <% else %>
              <div class="col-md-12">
                <a href="#" class="btn btn-lg btn-default btn-block" disabled="disabled">
                  <i class="fa fa-exclamation"></i>
                  <span><%= t('not_for_sale') %></span>
                </a>
              </div>
            <% end %>
            <div class="col-md-12">
              <%= render 'layouts/social_share', image: "#{request.protocol}#{request.host_with_port}#{@course.image.url(:large)}", text: "#{t('share_text')}#{translate.name}" %>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <!-- Recent Works -->
          <div class="headline">
            <h4><%= t('recent_course') %></h4>
          </div>
          <div class="margin-bottom-40">
            <ul id="list" class="bxslider">
              <% @recent_courses.each do |recent_course| %>
                <li>
                  <%= link_to course_path(recent_course, month: recent_course.time.strftime('%m').to_i) do %>
                    <em class="overflow-hidden">
                      <%= image_tag recent_course.image.url(:small), style: 'width:100%;' %>
                    </em>
                    <span>
                      <% translate = recent_course.course_translates.where(locale_id: session[:locale_id]).first %>
                      <h5>
                        <strong>
                          <%= truncate(translate.name, length: (session[:locale] == 'en')? 32 : 14) %>
                        </strong>
                      </h5>
                      <h5><%= "#{recent_course.time.strftime('%Y/%m/%d')}" %></h5>
                      <i><%= t('teacher') %>:&nbsp;<%= translate.teacher %></i>
                    </span>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div><!--/row-->
          <!-- End Recent Works -->
        </div>
      </div>
    </div>
  </div>
</div>